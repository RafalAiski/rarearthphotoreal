<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rare Earth Elements Supply Chain Flow - Photorealistic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            min-height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 42px;
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .subtitle {
            text-align: center;
            color: #b0b0c0;
            margin-bottom: 50px;
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        #sankey {
            width: 100%;
            height: 800px;
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.5));
        }
        .node rect {
            cursor: move;
            shape-rendering: geometricPrecision;
        }
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.5px;
            fill: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .link {
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .tooltip {
            position: absolute;
            padding: 12px 16px;
            font-size: 14px;
            background: rgba(20, 20, 30, 0.95);
            color: white;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .legend {
            margin-top: 40px;
            text-align: center;
            font-size: 14px;
            color: #b0b0c0;
            line-height: 1.6;
        }
        .annotation {
            font-size: 12px;
            font-weight: 300;
            fill: #b0b0c0;
            font-style: italic;
        }
        .stage-label {
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            fill: #ffffff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .glow {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RARE EARTH ELEMENTS: MINE TO MARKET</h1>
        <p class="subtitle">Global Supply Chain Visualization • 2023 Data</p>
        
        <div id="sankey"></div>
        <div class="tooltip"></div>
        <div class="legend">
            <p>China processes 90% of global rare earth oxides, creating a critical bottleneck in the supply chain.</p>
            <p>Even U.S. production from Mountain Pass, California is primarily exported to China for refining.</p>
        </div>
    </div>

    <script>
        // Set dimensions and margins
        const margin = {top: 40, right: 200, bottom: 80, left: 200};
        const width = 1600 - margin.left - margin.right;
        const height = 800 - margin.top - margin.bottom;

        // Create SVG with perspective transform
        const svg = d3.select("#sankey")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .style("transform", "perspective(2000px) rotateX(5deg)")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select(".tooltip");

        // Define gradients and filters
        const defs = svg.append("defs");

        // Metallic gradients for nodes
        const metalGradients = [
            {id: "metal-china", color1: "#e74c3c", color2: "#c0392b", color3: "#a93226"},
            {id: "metal-usa", color1: "#5dade2", color2: "#3498db", color3: "#2874a6"},
            {id: "metal-australia", color1: "#f4d03f", color2: "#f39c12", color3: "#d68910"},
            {id: "metal-myanmar", color1: "#bb8fce", color2: "#9b59b6", color3: "#7d3c98"},
            {id: "metal-thailand", color1: "#58d68d", color2: "#27ae60", color3: "#229954"},
            {id: "metal-others", color1: "#aeb6bf", color2: "#95a5a6", color3: "#7f8c8d"},
            {id: "metal-defense", color1: "#5d6d7e", color2: "#2c3e50", color3: "#1b2631"},
            {id: "metal-energy", color1: "#58d68d", color2: "#27ae60", color3: "#1e8449"},
            {id: "metal-auto", color1: "#eb984e", color2: "#e67e22", color3: "#ca6f1e"},
            {id: "metal-it", color1: "#5dade2", color2: "#3498db", color3: "#2e86c1"},
            {id: "metal-medical", color1: "#48c9b0", color2: "#1abc9c", color3: "#17a589"},
            {id: "metal-other-ind", color1: "#aeb6bf", color2: "#95a5a6", color3: "#7f8c8d"}
        ];

        metalGradients.forEach(grad => {
            const g = defs.append("linearGradient")
                .attr("id", grad.id)
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "0%")
                .attr("y2", "100%");
            
            g.append("stop")
                .attr("offset", "0%")
                .style("stop-color", grad.color1)
                .style("stop-opacity", 1);
            
            g.append("stop")
                .attr("offset", "50%")
                .style("stop-color", grad.color2)
                .style("stop-opacity", 1);
            
            g.append("stop")
                .attr("offset", "100%")
                .style("stop-color", grad.color3)
                .style("stop-opacity", 1);
        });

        // Glass-like gradient for flows
        const flowGradients = [
            {id: "flow-china", color: "#e74c3c"},
            {id: "flow-usa", color: "#3498db"},
            {id: "flow-australia", color: "#f39c12"},
            {id: "flow-myanmar", color: "#9b59b6"},
            {id: "flow-thailand", color: "#27ae60"},
            {id: "flow-others", color: "#95a5a6"}
        ];

        flowGradients.forEach(grad => {
            const g = defs.append("radialGradient")
                .attr("id", grad.id);
            
            g.append("stop")
                .attr("offset", "0%")
                .style("stop-color", grad.color)
                .style("stop-opacity", 0.8);
            
            g.append("stop")
                .attr("offset", "100%")
                .style("stop-color", grad.color)
                .style("stop-opacity", 0.3);
        });

        // Special gradient for Mountain Pass flow
        const mountainPassGradient = defs.append("linearGradient")
            .attr("id", "mountain-pass-gradient")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");
        
        mountainPassGradient.append("stop")
            .attr("offset", "0%")
            .style("stop-color", "#3498db")
            .style("stop-opacity", 0.8);
        
        mountainPassGradient.append("stop")
            .attr("offset", "50%")
            .style("stop-color", "#f39c12")
            .style("stop-opacity", 0.9);
        
        mountainPassGradient.append("stop")
            .attr("offset", "100%")
            .style("stop-color", "#e74c3c")
            .style("stop-opacity", 0.8);

        // Glow filter
        const glowFilter = defs.append("filter")
            .attr("id", "glow");
        
        glowFilter.append("feGaussianBlur")
            .attr("stdDeviation", "4")
            .attr("result", "coloredBlur");
        
        const feMerge = glowFilter.append("feMerge");
        feMerge.append("feMergeNode")
            .attr("in", "coloredBlur");
        feMerge.append("feMergeNode")
            .attr("in", "SourceGraphic");

        // Drop shadow filter
        const dropShadow = defs.append("filter")
            .attr("id", "drop-shadow")
            .attr("x", "-50%")
            .attr("y", "-50%")
            .attr("width", "200%")
            .attr("height", "200%");
        
        dropShadow.append("feGaussianBlur")
            .attr("in", "SourceAlpha")
            .attr("stdDeviation", "3");
        
        dropShadow.append("feOffset")
            .attr("dx", "0")
            .attr("dy", "4")
            .attr("result", "offsetblur");
        
        dropShadow.append("feFlood")
            .attr("flood-color", "#000000")
            .attr("flood-opacity", "0.5");
        
        dropShadow.append("feComposite")
            .attr("in2", "offsetblur")
            .attr("operator", "in");
        
        const feMerge2 = dropShadow.append("feMerge");
        feMerge2.append("feMergeNode");
        feMerge2.append("feMergeNode")
            .attr("in", "SourceGraphic");

        // Define the sankey diagram
        const sankey = d3.sankey()
            .nodeWidth(30)
            .nodePadding(20)
            .extent([[1, 1], [width - 1, height - 6]]);

        // Define the data
        const data = {
            nodes: [
                // Mining nodes
                {name: "China", fullName: "China Mining (70%)", category: "mining", id: "china-mining", value: 70},
                {name: "USA", fullName: "USA Mining (14%)", category: "mining", id: "usa-mining", value: 14},
                {name: "Australia", fullName: "Australia Mining (6%)", category: "mining", id: "australia-mining", value: 6},
                {name: "Myanmar", fullName: "Myanmar Mining (4%)", category: "mining", id: "myanmar-mining", value: 4},
                {name: "Thailand", fullName: "Thailand Mining (2%)", category: "mining", id: "thailand-mining", value: 2},
                {name: "Others", fullName: "Other Mining (4%)", category: "mining", id: "other-mining", value: 4},
                
                // Refining nodes
                {name: "China Refining", fullName: "China Refining (90%)", category: "refining", id: "china-refining", value: 90},
                {name: "Other Refining", fullName: "Other Refining (10%)", category: "refining", id: "other-refining", value: 10},
                
                // End industries
                {name: "Defense Tech", fullName: "Defense Technology", category: "industry", id: "defense"},
                {name: "Clean Energy", fullName: "Clean Energy Systems", category: "industry", id: "energy"},
                {name: "Automotive", fullName: "Automotive Industry", category: "industry", id: "automotive"},
                {name: "IT & Electronics", fullName: "IT & Electronics", category: "industry", id: "it"},
                {name: "Medical", fullName: "Medical Devices", category: "industry", id: "medical"},
                {name: "Other Industries", fullName: "Other Industries", category: "industry", id: "other-industries"}
            ],
            links: [
                // Mining to Refining
                {source: 0, target: 6, value: 70, flowId: "china"},
                {source: 1, target: 6, value: 12, flowId: "usa-china"},
                {source: 1, target: 7, value: 2, flowId: "usa"},
                {source: 2, target: 6, value: 5, flowId: "australia"},
                {source: 2, target: 7, value: 1, flowId: "australia"},
                {source: 3, target: 6, value: 4, flowId: "myanmar"},
                {source: 4, target: 6, value: 2, flowId: "thailand"},
                {source: 5, target: 7, value: 2, flowId: "others"},
                {source: 5, target: 6, value: 2, flowId: "others"},
                
                // Refining to Industries
                {source: 6, target: 8, value: 8, flowId: "refining"},
                {source: 6, target: 9, value: 20, flowId: "refining"},
                {source: 6, target: 10, value: 15, flowId: "refining"},
                {source: 6, target: 11, value: 25, flowId: "refining"},
                {source: 6, target: 12, value: 5, flowId: "refining"},
                {source: 6, target: 13, value: 17, flowId: "refining"},
                {source: 7, target: 8, value: 1, flowId: "other-refining"},
                {source: 7, target: 9, value: 2, flowId: "other-refining"},
                {source: 7, target: 10, value: 2, flowId: "other-refining"},
                {source: 7, target: 11, value: 3, flowId: "other-refining"},
                {source: 7, target: 12, value: 1, flowId: "other-refining"},
                {source: 7, target: 13, value: 1, flowId: "other-refining"}
            ]
        };

        // Calculate sankey layout
        const {nodes, links} = sankey(data);

        // Create shadows for 3D effect
        const shadows = svg.append("g")
            .attr("class", "shadows");

        // Add shadow paths
        shadows.selectAll(".shadow-link")
            .data(links)
            .enter().append("path")
            .attr("class", "shadow-link")
            .attr("d", d3.sankeyLinkHorizontal())
            .style("fill", "none")
            .style("stroke", "#000000")
            .style("stroke-width", d => Math.max(1, d.width))
            .style("stroke-opacity", 0.2)
            .attr("transform", "translate(0, 6)");

        // Add the links with glass effect
        const link = svg.append("g")
            .selectAll(".link")
            .data(links)
            .enter().append("g");

        // Base flow
        link.append("path")
            .attr("class", "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .style("stroke", d => {
                if (d.flowId === "usa-china") {
                    return "url(#mountain-pass-gradient)";
                }
                if (d.flowId === "refining") {
                    return "rgba(231, 76, 60, 0.6)";
                }
                if (d.flowId === "other-refining") {
                    return "rgba(149, 165, 166, 0.6)";
                }
                return `rgba(255, 255, 255, 0.4)`;
            })
            .style("stroke-width", d => Math.max(1, d.width))
            .style("fill", "none")
            .style("stroke-opacity", 0.8)
            .attr("filter", d => d.flowId === "usa-china" ? "url(#glow)" : null)
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .style("stroke-opacity", 1)
                    .attr("filter", "url(#glow)");
                
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.source.fullName.replace(/ \(\d+%?\)/, "")}</strong> → <strong>${d.target.fullName.replace(/ \(\d+%?\)/, "")}</strong><br/>Volume: ${d.value}%`)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this)
                    .style("stroke-opacity", 0.8)
                    .attr("filter", d.flowId === "usa-china" ? "url(#glow)" : null);
                
                tooltip.transition().duration(500).style("opacity", 0);
            });

        // Add highlight on top
        link.append("path")
            .attr("class", "link-highlight")
            .attr("d", d3.sankeyLinkHorizontal())
            .style("stroke", "rgba(255, 255, 255, 0.3)")
            .style("stroke-width", d => Math.max(1, d.width * 0.3))
            .style("fill", "none")
            .style("pointer-events", "none");

        // Add the nodes
        const node = svg.append("g")
            .selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x0},${d.y0})`);

        // Add 3D effect rectangles
        node.append("rect")
            .attr("height", d => d.y1 - d.y0)
            .attr("width", sankey.nodeWidth())
            .attr("x", 2)
            .attr("y", 2)
            .style("fill", "#000000")
            .style("opacity", 0.3);

        // Main rectangles with metallic gradient
        node.append("rect")
            .attr("height", d => d.y1 - d.y0)
            .attr("width", sankey.nodeWidth())
            .style("fill", d => {
                if (d.category === "mining") {
                    return `url(#metal-${d.id.split('-')[0]})`;
                } else if (d.category === "refining") {
                    return d.id === "china-refining" ? "url(#metal-china)" : "url(#metal-others)";
                } else {
                    const gradientMap = {
                        "defense": "metal-defense",
                        "energy": "metal-energy",
                        "automotive": "metal-auto",
                        "it": "metal-it",
                        "medical": "metal-medical",
                        "other-industries": "metal-other-ind"
                    };
                    return `url(#${gradientMap[d.id]})`;
                }
            })
            .style("stroke", "rgba(255, 255, 255, 0.2)")
            .style("stroke-width", 1)
            .attr("filter", "url(#drop-shadow)")
            .attr("rx", 3)
            .attr("ry", 3)
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("stroke", "rgba(255, 255, 255, 0.8)")
                    .style("stroke-width", 2);
                
                tooltip.transition().duration(200).style("opacity", .9);
                let value = d.sourceLinks.reduce((sum, link) => sum + link.value, 0) || 
                           d.targetLinks.reduce((sum, link) => sum + link.value, 0);
                tooltip.html(`<strong>${d.fullName}</strong><br/>Total Volume: ${value}%`)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("stroke", "rgba(255, 255, 255, 0.2)")
                    .style("stroke-width", 1);
                
                tooltip.transition().duration(500).style("opacity", 0);
            });

        // Add shine effect
        node.append("rect")
            .attr("height", d => (d.y1 - d.y0) * 0.4)
            .attr("width", sankey.nodeWidth() - 4)
            .attr("x", 2)
            .attr("y", 2)
            .attr("rx", 2)
            .attr("ry", 2)
            .style("fill", "rgba(255, 255, 255, 0.2)")
            .style("pointer-events", "none");

        // Add node labels with better positioning
        node.append("text")
            .attr("x", d => d.x0 < width / 3 ? -10 : (d.x0 > 2 * width / 3 ? sankey.nodeWidth() + 10 : sankey.nodeWidth() / 2))
            .attr("y", d => (d.y1 - d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", d => d.x0 < width / 3 ? "end" : (d.x0 > 2 * width / 3 ? "start" : "middle"))
            .text(d => d.fullName)
            .style("font-weight", "500");

        // Add percentage labels for mining nodes
        node.filter(d => d.category === "mining")
            .append("text")
            .attr("x", sankey.nodeWidth() / 2)
            .attr("y", d => (d.y1 - d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "middle")
            .text(d => d.value + "%")
            .style("font-size", "16px")
            .style("font-weight", "bold")
            .style("fill", "#ffffff")
            .style("text-shadow", "0 2px 4px rgba(0,0,0,0.8)");

        // Add stage labels
        const stages = [
            {text: "EXTRACTION", x: 0, desc: "Mining Operations"},
            {text: "PROCESSING", x: width * 0.45, desc: "Refining Facilities"},
            {text: "INDUSTRIES", x: width, desc: "End Applications"}
        ];

        const stageLabels = svg.append("g");
        
        stages.forEach(stage => {
            const g = stageLabels.append("g")
                .attr("transform", `translate(${stage.x}, -30)`);
            
            g.append("text")
                .attr("class", "stage-label")
                .attr("text-anchor", stage.x === 0 ? "start" : (stage.x === width ? "end" : "middle"))
                .style("font-size", "16px")
                .text(stage.text);
            
            g.append("text")
                .attr("text-anchor", stage.x === 0 ? "start" : (stage.x === width ? "end" : "middle"))
                .attr("y", 20)
                .style("font-size", "12px")
                .style("fill", "#808090")
                .style("font-weight", "300")
                .text(stage.desc);
        });

        // Add annotations
        const annotations = svg.append("g");
        
        // Mountain Pass annotation
        const mpAnnotation = annotations.append("g")
            .attr("transform", `translate(${width * 0.22}, ${height + 40})`);
        
        mpAnnotation.append("circle")
            .attr("r", 4)
            .style("fill", "#f39c12")
            .attr("class", "glow");
        
        mpAnnotation.append("text")
            .attr("class", "annotation")
            .attr("x", 10)
            .attr("dy", "0.35em")
            .text("Mountain Pass (California) → China export flow");

        // China dominance annotation
        const chinaAnnotation = annotations.append("g")
            .attr("transform", `translate(${width * 0.65}, ${height + 20})`);
        
        chinaAnnotation.append("rect")
            .attr("x", -100)
            .attr("y", -10)
            .attr("width", 200)
            .attr("height", 20)
            .attr("rx", 10)
            .style("fill", "rgba(231, 76, 60, 0.2)")
            .style("stroke", "rgba(231, 76, 60, 0.5)")
            .style("stroke-width", 1);
        
        chinaAnnotation.append("text")
            .attr("class", "annotation")
            .attr("text-anchor", "middle")
            .style("fill", "#ffffff")
            .style("font-weight", "500")
            .text("90% Global Refining Capacity");

    </script>
</body>
</html>